{% extends 'base.html.twig' %}

{% block title %}Hello BSXController!{% endblock %}

{% block body %}
    <h1>BSX Stock</h1>

    <table class="table table-bordered table-responsive">
        <tr>
            <td colspan="22">STOCK WATCHLIST</td>
        </tr>
        
        <tr>
            <th></th>
            <th>Name</th>
            <th style="width: 210px;">Current</th>
            <th>Deadstop</th>
            <th>Buy In</th>
            <th>Profit Point</th>
            <th>Target</th>
            <th>Golden</th>
            <th>Update Time (minutes)</th>
            <th>Actions</th>
        </tr>

        {% set options = [] %}
        {% for stock in watchlist %}
            {% if stock.type == 2 or stock.type == 3 %}
                {% set options = options|merge([stock]) %}
            {% else %}
                <tr data-id="{{ stock.id }}">
                    <td><img src="/images/logos/{{ stock.ticker }}.jpg" alt="" class="stock_table_logo"></td>
                    <td>{{ stock.name }}</td>
                    <td id="current_{{ stock.id }}">{{ stock.current }}</td>
                    <td class="status dead">{{ stock.deadstop }}</td>
                    <td class="status buy">{{ stock.buyin }}</td>
                    <td class="status pp">{{ stock.profitpoint }}</td>
                    <td class="status target">{{ stock.target }}</td>
                    <td class="status golden">{{ stock.golden }}</td>
                    <td><input class="watchtime" data-id="{{ stock.id }}" data-type="{{ stock.type }}" data-last="0" type="number" value='1' /></td>
                    <td><a href="/watchlist/delete/{{ stock.id }}" class="btn btn-danger">Delete</a></td>
                </tr>
            {% endif %}
        {% endfor %}

        <tr>
            <td colspan="22">OPTIONS WATCHLIST</td>
        </tr>
        
        <tr>
            <th></th>
            <th>Name</th>
            <th style="width: 210px;">Current</th>
            <th colspan="2">Buy In</th>
            <th colspan="3">Strike Price</th>
            <th>Update Time (minutes)</th>
            <th>Actions</th>
        </tr>

        {% for option in options %}
            <tr data-id="{{ option.id }}">
                <td><img src="/images/logos/{{ option.ticker }}.jpg" alt="" class="stock_table_logo"></td>
                <td>{{ option.name }}</td>
                <td id="current_{{ option.id }}">{{ option.current }}</td>
                <td colspan="2" class="status buy">{{ option.buyin }}</td>
                <td colspan="3" class="status pp">{{ option.profitpoint }}</td>
                <td><input class="watchtime" data-id="{{ option.id }}" data-type="{{ option.type }}" data-last="0" type="number" value='1' /></td>
                <td><a href="/watchlist/delete/{{ option.id }}" class="btn btn-danger">Delete</a></td>
            </tr>
        {% endfor %}


    </table>
    <a href="/watchlist/add" class="btn btn-primary">ADD</a>
    <a href="/" class="btn btn-primary">BACK TO MAIN</a>    

    <script>
    var ds = new Date();
    var startTime = ds.getTime();
    var prevTime = 0;
    var prev = [];
    var prev_icons = "";
    var max_icons = 12;
    var firstRun = true;

        $(function(){

        

             $(".watchtime").each(function(e,i){
                 prev.push([]);
             });

             console.log(prev);
            

            function checkStock(){
                //console.log("check");
                var d = new Date();
                var n = d.getTime();
                var diff = Math.floor((n - startTime) / 1000);
                //console.log(diff);
                
                $(".watchtime").each(function(i,e){
                    var id = $(this).attr("data-id");
                    var last = $(this).attr("data-last");
                    var checkSecond = (60 * parseFloat($(this).val()));
                    var row = $("tr[data-id="+ id +"]");

                    if((diff - last) > checkSecond || firstRun){
                        $(this).attr("data-last", diff);
                        $.post("/watchlist/check", {id:id}, function(json){
                            var c = (json.dir_up === 2) ? "bi arrow grey bi-dash-square-fill" : (json.dir_up === 1) ? "bi arrow green bi-arrow-up-square-fill" : "bi arrow red bi-arrow-down-square-fill";
                            if(prev[i].length === max_icons){
                                prev[i].shift();
                            }

                            prev[i].push('<i class="' + c + '"></i>');
                            prev_icons = '<br />';

                            if(prev[i].length > 0){prev[i].forEach(function(e,i2){prev_icons += prev[i][i2]});};
                            $("#current_" + id).html('<i class="' + c + '"></i> ' + json.current + prev_icons);
                            row.find(".status").removeClass("on");
                            row.find(".status.dead").removeClass("bad");

                            switch(json.status){
                                case(1):
                                    row.find(".status.dead").addClass("on bad");
                                    break;
                                case(2):
                                    row.find(".status.dead").addClass("on");
                                    break;
                                case(3):
                                    row.find(".status.buy").addClass("on");
                                    break;
                                case(4):
                                    row.find(".status.pp").addClass("on");
                                    break;
                                case(5):
                                    row.find(".status.target").addClass("on");
                                    break;
                                case(6):
                                    row.find(".status.golden").addClass("on");
                                    break;
                            }
                        });
                    }
                });

                firstRun = false;
                setTimeout(checkStock,1000)
            }

            checkStock();
        });

    </script>

{% endblock %}

